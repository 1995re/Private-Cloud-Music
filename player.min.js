"use strict";var _createClass=function(){function a(b,c){for(var f,d=0;d<c.length;d++)f=c[d],f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(b,f.key,f)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function formatTime(a){var b=Math.floor(a/60),c=Math.round(a-60*Math.floor(a/60));return 10>c?b+":0"+c:60==c?b+1+":00":b+":"+c}var Player=function(){function a(b){_classCallCheck(this,a),this.api=b.api,this.path=b.defaultFolder,this.loop=0,this.order=0,this.audio=b.audioEl,this.playlist=document.getElementById("playlist"),this.folderlist=document.getElementById("folderlist"),this.nowPlaying=document.getElementById("nowPlaying"),this.freshFolderlist(),this.urlMatch(),this.fetchData(),document.getElementById("btn-loop").innerHTML=1==this.loop?"Loop: \u221A":"Loop: \xD7",document.getElementById("btn-order").innerHTML=1==this.order?"Order: \u221A":"Order: \xD7"}return _createClass(a,[{key:"playAtIndex",value:function playAtIndex(b){this.audio.pause(),this.currentIndex=b,this.audio.src=this.path+this.data[b].fileName,this.audio.load(),this.audio.play(),window.history.replaceState("","Useless Title","#/"+this.path+this.data[b].fileName+"/"),this.nowPlaying.innerHTML=decodeURIComponent(this.data[b].fileName)}},{key:"freshFolderlist",value:function freshFolderlist(){var b=new XMLHttpRequest;b.open("POST",this.api,!1),b.setRequestHeader("Content-type","application/x-www-form-urlencoded");var c=this;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var d=JSON.parse(b.responseText);return 200==d.status?void d.result.data.forEach(function(f){var h=decodeURIComponent(f);null==c.path&&(c.path=f+"/");var j=document.createElement("a");j.setAttribute("aim",f);var k=document.createElement("li");k.textContent=h+"/",j.appendChild(k),c.folderlist.appendChild(j)}):void console.error("Fetch error. Reason: "+d.message+" Url: ./api.php")}},b.onerror=function(){console.error("Ajax load folders failed. Status: "+b.status+" Url: "+c.api)},b.send("do=getfolders")}},{key:"fetchData",value:function fetchData(){var c=this,b=new XMLHttpRequest;b.open("POST",this.api,!0),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var d=JSON.parse(b.responseText);return 200==d.status?void(c.data=d.result.data,c.freshPlaylist()):void console.error("Fetch error. Reason: "+d.message+" Url: "+c.api)}},b.onerror=function(){console.error("Ajax load playlist failed. Status: "+b.status+" Url: "+c.api),c.data=[]},b.send("do=getplaylist&folder="+this.path)}},{key:"freshPlaylist",value:function freshPlaylist(){var f=this,c=this.data,d="";this.playlist.innerHTML="",c.forEach(function(h,j){d=decodeURIComponent(h.fileName);var k=document.createElement("a");k.setAttribute("index",j);var l=document.createElement("li");l.textContent=d,k.appendChild(l),f.playlist.appendChild(k)});for(var g=this,b=document.querySelectorAll("#playlist a"),_loop=function(h){var h=b[h];h.onclick=function(){g.playAtIndex(h.getAttribute("index"))}};i<b.length;i++)_loop(0)}},{key:"urlMatch",value:function urlMatch(){var b=!1,c=/[#][\/](.*[\/])(.*.[a-zA-z0-9]{1,3})[\/]/,d=c.exec(location.href);null!=d&&(b=!0,this.path=d[1],this.audio.src=this.path+d[2],this.audio.play(),this.nowPlaying.innerHTML=decodeURIComponent(d[2])),b||(c=/[#][\/](.*[\/])/,d=c.exec(location.href),null!=d&&(b=!0,this.path=d[1]))}},{key:"ready",value:function ready(){var c=this;this.audio.ontimeupdate=function(){document.getElementById("curTime").innerHTML=formatTime(c.audio.currentTime),document.getElementById("totalTime").innerHTML=formatTime(c.audio.duration),document.getElementById("timebar").style.width=100*(c.audio.currentTime/c.audio.duration)+"%";for(var h=0,j=0;j<c.audio.buffered.length;++j)h=h<c.audio.buffered.end(j)?c.audio.buffered.end(j):h;document.getElementById("bufferbar").style.width=100*(h/c.audio.duration)+"%"},this.audio.onpause=function(){document.getElementById("btn-play").innerHTML="Play"},this.audio.onplay=function(){document.getElementById("btn-play").innerHTML="Pause"};var d=this;document.getElementById("progressbar").onclick=function(h){var j=this.getBoundingClientRect(),k=(h.clientX-j.left)/j.width;d.audio.currentTime=d.audio.duration*k};for(var g,b=document.getElementsByTagName("button"),f=0;f<b.length;f++)g=b[f],g.onclick=function(){this.data[this.currentIndex]&&(this.nowPlaying.innerHTML=decodeURIComponent(this.data[this.currentIndex].fileName))};document.getElementById("btn-play").onclick=function(){c.audio.paused?c.audio.play():c.audio.pause(),-1==c.currentIndex&&0==c.audio.readyState&&document.getElementById("btn-next").click()},document.getElementById("btn-next").onclick=function(){-1==c.currentIndex?c.playAtIndex(0):c.currentIndex==c.data.length-1?c.playAtIndex(0):c.playAtIndex(+c.currentIndex+1)},document.getElementById("btn-prev").onclick=function(){-1==c.currentIndex?c.playAtIndex(0):0==c.currentIndex?c.playAtIndex(c.data.length-1):c.playAtIndex(+c.currentIndex-1)},document.getElementById("btn-loop").onclick=function(){c.loop=1-c.loop,1==c.loop?(c.audio.loop=!0,document.getElementById("btn-loop").innerHTML="Loop: \u221A"):(c.audio.loop=!1,document.getElementById("btn-loop").innerHTML="Loop: \xD7")},document.getElementById("btn-order").onclick=function(){c.order=1-c.order,1==c.order?(c.audio.onended=function(){0==c.loop&&document.getElementById("btn-next").click()},document.getElementById("btn-order").innerHTML="Order: \u221A"):(c.audio.onended=void 0,document.getElementById("btn-order").innerHTML="Order: \xD7")};for(var b=document.querySelectorAll("#folderlist a"),_loop2=function(h){var h=b[h];h.onclick=function(){d.path=h.getAttribute("aim")+"/",d.fetchData()}};_i<b.length;_i++)_loop2(0)}}]),a}();