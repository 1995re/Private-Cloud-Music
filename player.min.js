"use strict";var _createClass=function(){function a(b,c){for(var f,d=0;d<c.length;d++)f=c[d],f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(b,f.key,f)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function formatTime(a){var b=Math.floor(a/60),c=Math.round(a-60*Math.floor(a/60));return 10>c?b+":0"+c:60==c?b+1+":00":b+":"+c}var Player=function(){function a(b){_classCallCheck(this,a),this.audioTag=b.audioEl,this.api=b.api,this.path=b.defaultFolder,this.audio=this.audioTag.get(0),this.playlist=$("#playlist"),this.folderlist=$("#folderlist"),this.nowPlaying=document.getElementById("nowPlaying"),this.freshFolderlist(),this.urlMatch(),this.fetchData(),document.getElementById("btn-loop").innerHTML=1==this.loop?"Loop: \u221A":"Loop: \xD7",document.getElementById("btn-order").innerHTML=1==this.order?"Order: \u221A":"Order: \xD7"}return _createClass(a,[{key:"playAtIndex",value:function playAtIndex(b){this.audio.pause(),this.currentIndex=b,this.audio.src=this.path+this.data[b].fileName,this.audio.load(),this.audio.play(),window.history.replaceState("","Test Title","#/"+this.path+this.data[b].fileName+"/"),this.nowPlaying.innerHTML=decodeURIComponent(this.data[b].fileName)}},{key:"freshFolderlist",value:function freshFolderlist(){var b=new XMLHttpRequest;b.open("POST",this.api,!1),b.setRequestHeader("Content-type","application/x-www-form-urlencoded");var c=this;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var d=JSON.parse(b.responseText);return 200==d.status?void d.result.data.forEach(function(f){var h=decodeURIComponent(f);null==c.path&&(c.path=f+"/"),c.folderlist.append($("<a>").attr("aim",f).append([$("<li>").text(h+"/")]))}):void console.error("Fetch error. Reason: "+d.message+" Url: ./api.php")}},b.onerror=function(){console.error("Ajax load folders failed. Status: "+b.status+" Url: "+c.api)},b.send("do=getfolders")}},{key:"fetchData",value:function fetchData(){var c=this,b=new XMLHttpRequest;b.open("POST",this.api,!0),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var d=JSON.parse(b.responseText);return 200==d.status?void(c.data=d.result.data,c.freshPlaylist()):void console.error("Fetch error. Reason: "+d.message+" Url: "+c.api)}},b.onerror=function(){console.error("Ajax load playlist failed. Status: "+b.status+" Url: "+c.api),c.data=[]},b.send("do=getplaylist&folder="+this.path)}},{key:"freshPlaylist",value:function freshPlaylist(){var d=this,b=this.data,c="";this.playlist.empty(),b.forEach(function(g,h){c=decodeURIComponent(g.fileName),d.playlist.append($("<a>").attr("index",h).append([$("<li>").text(c)]))});var f=this;$("#playlist a").click(function(){f.playAtIndex($(this).attr("index"))})}},{key:"urlMatch",value:function urlMatch(){var b=!1,c=/[#][\/](.*[\/])(.*.[a-zA-z0-9]{1,3})[\/]/,d=c.exec(location.href);null!=d&&(b=!0,this.path=d[1],this.audio.src=this.path+d[2],this.audio.play(),this.nowPlaying.innerHTML=decodeURIComponent(d[2])),b||(c=/[#][\/](.*[\/])/,d=c.exec(location.href),null!=d&&(b=!0,this.path=d[1]))}},{key:"ready",value:function ready(){var b=this;this.audio.ontimeupdate=function(){document.getElementById("curTime").innerHTML=formatTime(b.audio.currentTime),document.getElementById("totalTime").innerHTML=formatTime(b.audio.duration),document.getElementById("timebar").style.width=100*(b.audio.currentTime/b.audio.duration)+"%";for(var d=0,f=0;f<b.audio.buffered.length;++f)d=d<b.audio.buffered.end(f)?b.audio.buffered.end(f):d;document.getElementById("bufferbar").style.width=100*(d/b.audio.duration)+"%"},this.audio.onpause=function(){document.getElementById("btn-play").innerHTML="Play"},this.audio.onplay=function(){document.getElementById("btn-play").innerHTML="Pause"};var c=this;document.getElementById("progressbar").onclick=function(d){var f=this.getBoundingClientRect(),g=(d.clientX-f.left)/f.width;c.audio.currentTime=c.audio.duration*g},$("*").on("click","button",function(){b.data[b.currentIndex]&&(b.nowPlaying.innerHTML=decodeURIComponent(b.data[b.currentIndex].fileName))}),document.getElementById("btn-play").onclick=function(){b.audio.paused?b.audio.play():b.audio.pause(),-1==b.currentIndex&&0==b.audio.readyState&&document.getElementById("btn-next").click()},document.getElementById("btn-next").onclick=function(){-1==b.currentIndex?b.playAtIndex(0):b.currentIndex==b.data.length-1?b.playAtIndex(0):b.playAtIndex(+b.currentIndex+1)},document.getElementById("btn-prev").onclick=function(){-1==b.currentIndex?b.playAtIndex(0):0==b.currentIndex?b.playAtIndex(b.data.length-1):b.playAtIndex(+b.currentIndex-1)},document.getElementById("btn-loop").onclick=function(){b.loop=1-b.loop,1==b.loop?(b.audio.loop=!0,document.getElementById("btn-loop").innerHTML="Loop: \u221A"):(b.audio.loop=!1,document.getElementById("btn-loop").innerHTML="Loop: \xD7")},document.getElementById("btn-order").onclick=function(){b.order=1-b.order,1==b.order?(b.audio.onended=function(){0==b.loop&&document.getElementById("btn-next").click()},document.getElementById("btn-order").innerHTML="Order: \u221A"):(b.audio.onended=void 0,document.getElementById("btn-order").innerHTML="Order: \xD7")},$("#folderlist a").click(function(){c.path=$(this).attr("aim")+"/",c.fetchData()})}}]),a}();